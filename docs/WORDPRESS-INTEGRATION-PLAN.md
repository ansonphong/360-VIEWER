# WordPress Theme Integration Plan - Updated for v3.0 Architecture

## Overview
Integration plan for adding the Phong 360 Viewer as a gallery type in the Postworld WordPress theme, adapted for the new modular "Russian Doll" architecture.

---

## Phase 1: ‚úÖ COMPLETED - 360 Viewer Refactoring

### What Was Done:
1. ‚úÖ **Modular "Russian Doll" Architecture** created:
   - **Layer 1**: `core/phong-360-viewer-core.js` - Ultra-lightweight single image viewer
   - **Layer 2**: `extensions/phong-360-multi-image.js` - Multi-image + resolution management
   - **Layer 3**: `extensions/phong-360-library-ui.js` - Browsable library interface

2. ‚úÖ **V3.0 Library Format** implemented:
   - Semantic resolution naming (8K, 4K, 2K instead of Q100, Q75, Q50)
   - Adaptive loading based on device/bandwidth
   - Configurable via `resolutions.json`
   - Generated by `build_library.py`

3. ‚úÖ **User Preferences** with localStorage:
   - Resolution preference saved (`phong360.preferences.resolution`)
   - Projection preference saved (`phong360.preferences.projection`)

4. ‚úÖ **Modern UI**:
   - Callback pattern for info display (best practices)
   - Scrollable library panel
   - Resolution selector with file sizes
   - Clean toolbar layout

---

## Phase 2: Prepare 360 Viewer for WordPress

### Step 1: Create WordPress-Friendly Build

**Location**: `/360.phong.com/dist/`

Create a distributable package:

```bash
# Files to include in WordPress integration:
dist/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îî‚îÄ‚îÄ phong-360-viewer-core.js
‚îú‚îÄ‚îÄ extensions/
‚îÇ   ‚îú‚îÄ‚îÄ phong-360-multi-image.js
‚îÇ   ‚îî‚îÄ‚îÄ phong-360-library-ui.js (optional for WP)
‚îú‚îÄ‚îÄ styles.css
‚îî‚îÄ‚îÄ README-WORDPRESS.md
```

**Key Changes for WordPress**:
1. Make `libraryUrl` optional in multi-image manager
2. Create simplified init for WordPress (no library panel needed)
3. Add WordPress-specific CSS classes

### Step 2: Add as Git Submodule to Postworld Theme

**Location**: `/phong.com/wp-content/themes/postworld/assets/360-viewer/`

```bash
cd wp-content/themes/postworld/assets/
git submodule add https://github.com/ansonphong/360-VIEWER.git 360-viewer
```

Or copy the `dist/` folder directly into theme assets.

---

## Phase 3: WordPress Theme Integration

### Step 1: Register New Gallery Type "360"

**File**: `inc/classes/class-gallery-handler.php`

Find the `GALLERY_TYPES` constant and add `'360'`:

```php
const GALLERY_TYPES = [
    'horizontal',
    'vertical', 
    'grid',
    'masonry',
    '360'  // ADD THIS
];
```

### Step 2: Add Metabox Option

**File**: `inc/admin/metaboxes/gallery-metabox.php`

Add radio option for 360 Viewer (around line 220-280):

```php
<p style="margin: 0 0 8px 0;">
    <label style="display: block; cursor: pointer;">
        <input type="radio" 
               name="postworld_gallery_type" 
               value="360" 
               <?php checked($gallery_type, '360'); ?>>
        <strong>üåê <?php _e('360¬∞ Viewer', 'postworld'); ?></strong>
        <br><small><?php _e('Interactive 360-degree equirectangular images', 'postworld'); ?></small>
    </label>
</p>
```

### Step 3: Create Gallery Template Part

**File**: `template-parts/galleries/gallery-360.php` (NEW)

```php
<?php
/**
 * Template part for displaying 360¬∞ viewer gallery
 *
 * @package Postworld
 */

$post_id = get_the_ID();
$gallery_images = postworld_get_gallery_images($post_id);

if (empty($gallery_images)) {
    return;
}

// Prepare images for 360 viewer
$viewer_images = postworld_prepare_360_images($gallery_images);
?>

<div class="gallery-360-container" id="gallery-360-<?php echo esc_attr($post_id); ?>">
    <div id="viewer-360-<?php echo esc_attr($post_id); ?>"></div>
    <div class="viewer-360-controls">
        <button id="projection-toggle-<?php echo esc_attr($post_id); ?>" class="viewer-360-button">
            üåê Stereographic
        </button>
        <select id="resolution-selector-<?php echo esc_attr($post_id); ?>" class="viewer-360-select">
            <option value="4k">4K</option>
            <option value="2k">2K</option>
        </select>
    </div>
</div>

<script>
(function() {
    const viewerData = <?php echo wp_json_encode($viewer_images); ?>;
    
    // Initialize core viewer (Layer 1)
    const core = new Phong360ViewerCore({
        containerId: 'viewer-360-<?php echo esc_js($post_id); ?>',
        config: {
            viewRotation: {
                autoRotate: true,
                autoRotationRate: 1
            }
        }
    });
    
    // Initialize multi-image manager (Layer 2)
    const multiViewer = new Phong360MultiImage({
        core: core,
        images: viewerData,
        baseUrl: '',
        adaptiveLoading: true
    });
    
    // Load first image
    if (viewerData.length > 0) {
        multiViewer.loadImageById(viewerData[0].id);
    }
    
    // Setup projection toggle
    const projectionBtn = document.getElementById('projection-toggle-<?php echo esc_js($post_id); ?>');
    let currentProjection = 1;
    projectionBtn.addEventListener('click', function() {
        currentProjection = currentProjection === 0 ? 1 : 0;
        core.switchProjection(currentProjection);
        projectionBtn.textContent = currentProjection === 0 ? 'üìê Gnomonic' : 'üåê Stereographic';
    });
    
    // Setup resolution selector
    const resolutionSelect = document.getElementById('resolution-selector-<?php echo esc_js($post_id); ?>');
    resolutionSelect.addEventListener('change', function() {
        multiViewer.switchResolution(this.value);
    });
})();
</script>
```

### Step 4: Create Helper Functions

**File**: `inc/360-viewer-functions.php` (NEW)

```php
<?php
/**
 * 360 Viewer Helper Functions
 *
 * @package Postworld
 */

/**
 * Prepare gallery images for 360 viewer
 *
 * @param array $image_ids Array of attachment IDs
 * @return array Formatted images array for viewer
 */
function postworld_prepare_360_images($image_ids) {
    $images = [];
    
    foreach ($image_ids as $image_id) {
        $image_meta = wp_get_attachment_metadata($image_id);
        $image_url = wp_get_attachment_url($image_id);
        
        if (!$image_url) {
            continue;
        }
        
        // Generate resolutions array
        $resolutions = [];
        
        // Original (assume 4K)
        $resolutions[] = [
            'id' => '4k',
            'label' => '4K',
            'width' => $image_meta['width'] ?? 4096,
            'height' => $image_meta['height'] ?? 2048,
            'path' => $image_url,
            'fileSize' => filesize(get_attached_file($image_id)),
            'default' => true,
            'bandwidth' => 'medium'
        ];
        
        // 2K version (if large size exists)
        $large_url = wp_get_attachment_image_url($image_id, 'large');
        if ($large_url && $large_url !== $image_url) {
            $large_meta = wp_get_attachment_metadata($image_id);
            $resolutions[] = [
                'id' => '2k',
                'label' => '2K',
                'width' => $large_meta['sizes']['large']['width'] ?? 2048,
                'height' => $large_meta['sizes']['large']['height'] ?? 1024,
                'path' => $large_url,
                'fileSize' => filesize(get_attached_file($image_id)),
                'bandwidth' => 'low'
            ];
        }
        
        $images[] = [
            'id' => (string)$image_id,
            'name' => get_the_title($image_id),
            'resolutions' => $resolutions,
            'thumbnail' => [
                'path' => wp_get_attachment_image_url($image_id, 'thumbnail')
            ]
        ];
    }
    
    return $images;
}

/**
 * Check if post uses 360 gallery
 *
 * @param int $post_id Post ID
 * @return bool
 */
function postworld_is_360_gallery($post_id = null) {
    if (!$post_id) {
        $post_id = get_the_ID();
    }
    
    $gallery_type = get_post_meta($post_id, 'postworld_gallery_type', true);
    return $gallery_type === '360';
}

/**
 * Get 360 viewer instance for post
 *
 * @param int $post_id Post ID
 * @return string HTML for 360 viewer
 */
function postworld_get_360_viewer($post_id = null) {
    if (!$post_id) {
        $post_id = get_the_ID();
    }
    
    ob_start();
    get_template_part('template-parts/galleries/gallery', '360');
    return ob_get_clean();
}
```

**Include in functions.php**:
```php
// 360 Viewer Functions
require_once get_template_directory() . '/inc/360-viewer-functions.php';
```

### Step 5: Enqueue Assets in functions.php

**File**: `functions.php` (modify around line 455)

```php
// Enqueue 360 Viewer assets if needed
if (is_singular('post') && postworld_is_360_gallery()) {
    // Three.js dependency
    wp_enqueue_script(
        'threejs',
        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
        [],
        'r128',
        true
    );
    
    // 360 Viewer Core (Layer 1)
    wp_enqueue_script(
        'phong-360-viewer-core',
        get_template_directory_uri() . '/assets/360-viewer/core/phong-360-viewer-core.js',
        ['threejs'],
        POSTWORLD_VERSION,
        true
    );
    
    // Multi-Image Manager (Layer 2)
    wp_enqueue_script(
        'phong-360-multi-image',
        get_template_directory_uri() . '/assets/360-viewer/extensions/phong-360-multi-image.js',
        ['phong-360-viewer-core'],
        POSTWORLD_VERSION,
        true
    );
    
    // 360 Viewer Styles
    wp_enqueue_style(
        'phong-360-viewer',
        get_template_directory_uri() . '/assets/360-viewer/styles.css',
        [],
        POSTWORLD_VERSION
    );
}
```

### Step 6: Update single.php Template

**File**: `single.php` (around line 58)

Add check for 360 gallery type:

```php
<?php 
// Check for 360 gallery
$has_360_gallery = postworld_is_360_gallery() && postworld_has_gallery();

if ($has_360_gallery): ?>
    <!-- Hero Section: 360¬∞ Viewer -->
    <section class="post-hero-section post-gallery-section full-width gallery-at-top" data-gallery-type="360">
        <?php get_template_part('template-parts/galleries/gallery', '360'); ?>
    </section>

<?php elseif ($has_horizontal_gallery): ?>
    <!-- Hero Section: Full-width horizontal gallery -->
    <section class="post-hero-section post-gallery-section full-width gallery-at-top" data-gallery-type="horizontal">
        <?php get_template_part('template-parts/galleries/gallery', 'horizontal'); ?>
    </section>

<?php elseif (has_post_thumbnail() && !$hide_featured_image): ?>
    <!-- Featured Image -->
```

### Step 7: Add CSS Styling

**File**: `style.css` (or create `assets/360-viewer/wordpress-overrides.css`)

```css
/* ==========================================================================
   360 VIEWER GALLERY
   ========================================================================== */

.gallery-360-container {
    width: 100%;
    height: 70vh;
    min-height: 400px;
    position: relative;
    background: #000;
}

.gallery-360-container > div:first-child {
    width: 100%;
    height: calc(100% - 50px); /* Leave space for controls */
}

.viewer-360-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 10;
}

.viewer-360-button,
.viewer-360-select {
    padding: 10px 16px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.viewer-360-button:hover,
.viewer-360-select:hover {
    background-color: rgba(0, 0, 0, 0.9);
    border-color: rgba(255, 255, 255, 0.6);
}

/* Ensure canvas fills container */
.gallery-360-container canvas {
    width: 100% !important;
    height: 100% !important;
}

/* Full-width hero section */
.post-gallery-section[data-gallery-type="360"] {
    margin: 0;
    padding: 0;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .gallery-360-container {
        height: 50vh;
        min-height: 300px;
    }
    
    .viewer-360-controls {
        bottom: 10px;
        right: 10px;
        flex-direction: column;
    }
}
```

---

## Phase 4: Testing & Documentation

### Testing Checklist:

- [ ] Create test post with 360 gallery type selected
- [ ] Upload equirectangular images via WordPress media library
- [ ] Insert gallery shortcode with multiple images
- [ ] Verify 360 viewer initializes correctly
- [ ] Test image navigation between multiple 360 images
- [ ] Test projection switching (Gnomonic/Stereographic)
- [ ] Test resolution switching (4K/2K)
- [ ] Test on mobile devices and tablets
- [ ] Verify localStorage preferences persist
- [ ] Check that other gallery types still work
- [ ] Test in different browsers
- [ ] Verify admin metabox appears correctly

### Documentation:

**Create**: `assets/360-viewer/README-WORDPRESS.md`

```markdown
# 360 Viewer WordPress Integration

## Adding 360¬∞ Images to Posts

1. Edit your post
2. In the Gallery metabox, select "üåê 360¬∞ Viewer"
3. Add your gallery shortcode with 360¬∞ equirectangular images
4. Images should be at least 4096x2048 for best quality

## Image Requirements

- Format: JPG or PNG equirectangular projection
- Recommended size: 4096x2048 or 8192x4096
- Aspect ratio: 2:1 (width:height)

## Features

- Auto-rotation
- Two projection modes (Gnomonic/Stereographic)
- Adaptive resolution (4K/2K based on device)
- Touch/mouse/keyboard controls
- Saved user preferences

## Customization

Edit `template-parts/galleries/gallery-360.php` to customize:
- Container dimensions
- Control position
- Auto-rotation settings
- Available resolutions
```

---

## Summary of Key Differences from Original Plan

### What Changed:
1. ‚úÖ **Architecture is now modular** (3 layers instead of monolithic)
2. ‚úÖ **No library panel needed** for WordPress (simpler integration)
3. ‚úÖ **V3.0 library format** with semantic resolution naming
4. ‚úÖ **localStorage preferences** for better UX
5. ‚úÖ **Callback pattern** for extensibility

### WordPress Integration Benefits:
- **Layer 1 only** for basic single-image viewer
- **Layer 2** for multi-image posts
- **No Layer 3** needed (no library tree UI in WordPress)
- Lighter weight and faster loading
- Easier to customize per WordPress needs

### Next Steps:
1. Create `dist/` folder with WordPress-ready files
2. Test integration in local WordPress environment
3. Document WordPress-specific configuration
4. Create demo post with sample 360¬∞ images

